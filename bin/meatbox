#!/bin/sh

set -ex

usage() {
  cat << HEREDOC
meatbox

Usage:
  meatbox help       show this screen
  meatbox bootstrap  installs the dependencies required to use commands
  meatbox setup      configure the system as it was a clean operating system,
                     creating core directories, installing drivers and our
                     desired packages, updating our core system packages and
                     applying our customized configuration     
  meatbox update     installs & updates our desired packages, our core system
                     packages, and applies any new or updated configuration that
                     may have changed since our last run

HEREDOC
}

log_message() {
  printf "%s" "$*"
}

meatbox_run_script() {
  ctx="$1"
  cmd="$2"

  if [ -f "$MEATBOX_SCRIPTS_DIR/$ctx/$cmd.sh" ]; then
    (cd "$MEATBOX_SCRIPTS_DIR/$ctx" && "./$cmd.sh")
  fi
}

meatbox_run() {
  kernel="$(uname -s | lowercase)"

  meatbox_run_script "$kernel" "$cmd"
  
  if [ "$kernel" = "linux" ]; then
    distro=""

    # cat /etc/*release

    # ID=alpine
    # NAME="Alpine Linux"

    # ID=antergos
    # ID_LIKE=archlinux
    # NAME="Antergos Linux"

    # DISTRIB_ID=Arch
    # NAME="ArchBang Linux"
    # ID=arch

    meatbox_run_script "$distro" "$cmd"
  fi

  meatbox_run_script "agnostic" "$cmd"
}

meatbox_help() {
  usage
}

meatbox() {
  cmd="$1"

  case "$cmd" in
    bootstrap|setup|update)
      start-sudo-loop "$MEATBOX_PASSWORD"
      meatbox_run "$cmd"      
      ;;
    *) meatbox_help ;;
  esac
}

meatbox "$@"
