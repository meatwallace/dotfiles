#!/bin/sh

set -eo pipefail

usage() {
  cat << HEREDOC
meatbox

Usage:
  meatbox help       show this screen
  meatbox bootstrap  installs the dependencies required to use commands
  meatbox setup      configure the system as it was a clean operating system,
                     creating core directories, installing drivers and our
                     desired packages, updating our core system packages and
                     applying our customized configuration     
  meatbox update     installs & updates our desired packages, our core system
                     packages, and applies any new or updated configuration that
                     may have changed since our last run

HEREDOC
}

log_message() {
  printf "%s" "$*"
}

meatbox_run_script() {
  directory="$1"
  script="$2"

  (cd "$MEATBOX_SCRIPTS_DIR/$directory" && "./$script")
}

meatbox_run_universal_script() {
  script="$1"

  meatbox_run_script "universal" "$script"
}

meatbox_run_os_script() {
  script="$1"
  os="$(uname -s | lowercase)"

  if [ -f "$MEATBOX_SCRIPTS_DIR/$os/$script" ]; then
    meatbox_run_script "$os" "$script"
  fi
}

meatbox_help() {
  usage
}

meatbox_bootstrap() {
  start-sudo-loop "$MEATBOX_PASSWORD"

  meatbox_run_os_script "bootstrap.sh"
  meatbox_run_universal_script "bootstrap.sh"
}

if [ "$1" = "bootstrap" ]; then
  meatbox_bootstrap

  exit 0
fi

meatbox_setup() {
  start-sudo-loop "$MEATBOX_PASSWORD"

  meatbox_run_os_script "setup.sh"
  meatbox_run_universal_script "setup.sh"
}

meatbox_update() {
  start-sudo-loop "$MEATBOX_PASSWORD"

  meatbox_run_os_script "update.sh"
  meatbox_run_universal_script "update.sh"
}

meatbox() {
  cmd="$1"

  case "$cmd" in
    bootstrap|setup|update) "meatbox_$cmd" ;;
    *) meatbox_help ;;
  esac
}

meatbox "$@"
